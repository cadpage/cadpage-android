package net.anei.cadpage.parsers.PA;

import java.util.Properties;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import net.anei.cadpage.parsers.FieldProgramParser;
import net.anei.cadpage.parsers.MsgInfo.Data;

/*
Delaware County, PA (alternate)
Contact: Steve Castellano <stevecast2024@gmail.com>
Sender: Many

X1: OAK AV X2: PEMBROKE AV Nature: FIRE-NON  VEHICLE FIRE Time: 13:25:12  Inc: F11032418
6636 PERRY AV UD  X2: MONTGOMERY AV Nature: ALS-EMS  RESPIRATORY DIFFICULTY Time: 12:13:17  Notes:  67 Y/O FEMALE   Inc: F11032408
507 HOLLY RD YE  X1: MYRA AV X2: BAILEY RD Nature: FIRE-BLD  BUILDING FIRE, RES/DWELLING Time: 20:21:17  Notes: STOVE   Inc: F11031897
39 E PROVIDENCE RD YE  X1: S LANSDOWNE AV X2: ELBERON AV Nature: FIRE-BLD  BUILDING FIRE, RES/DWELLING Time: 18:28:43  Notes: STOVE Inc: F11031009
957 BALTIMORE AV EL : @BALTIMORE PIKE CHECK CASHING X1: E BALTIMORE AV X2: E BALTIMORE AV Nature: FIRE-BLD  BUILDING FIRE, RES/DWELLING Time: 20:39:44  Notes: ODOR OF SMOKE 2ND FLOOR   2ND EMERGENCY 20   Inc: F1103170
115 S EAGLE RD HV : @56 MANOA FIRE CO X1: WYNDMOOR RD X2: STANLEY AV Nature: FIRE-OTH  COVER ASSIGNMENT Time: 13:25:09  Notes:  1 ENG FROM STA 20    CH 9   Inc: F11029664
801 FERN ST YE  X1: PARMLEY AV X2: W COBBS CREEK PKWY Nature: ALS-EMS FALL W/TRAUMA Time: 03:36:04  Notes: HEAD INJURY   DIABETIC PATIENT ENGINE ASSIST EMS   FD RESPOND AT EMERGENCY SPEED   Inc: F11028163
2402 ALFRED DR YE,A  X1: HEATHER CIR X2: KAREN DR Nature: FIRE-BLD BUILDING FIRE, COMMERCIAL BLDG Time: 13:37:14  Notes:  STOVE   Inc: F11027836
11 WILDWOOD AV EL  X1: E BALTIMORE AV X2: PEMBROKE AV Nature: ASSIST FD TO ASSIST EMS Time: 00:15:59  Notes: LEG WOUND - DIABETIC - NO BLOOD THINNERS   65YOM   3RD EMER 103   LIFT ASSIST   Inc: F11029789
X1: BALTIMORE AV X2: LEXINGTON AV Nature: ALS-EMS  SEIZURES Time: 01:53:58  Inc: F11030225
X1: WEST CHESTER PKE X2: PARK AV Nature: DISASTER  EMS BOX ALARM Time: 15:29:36  Inc: F11028912
136 BEVERLY AV EL  X1: PEMBROKE AV X2: EMERSON AV Nature: ALARM AUTOMATIC FIRE ALARM Time: 08:35:32  Notes: UPSTAIRS SMOKE DET RES/SCOTT   Inc: F11027387
164 LEXINGTON AV EL : @24 EAST LANSDOWNE FIRE CO X1: PEMBROKE AV X2: EMERSON AV Nature: TEST  PRINTER TEST Time: 11:06:09  Inc: F11023838
269 HIRST AV EL  X1: EMERSON AV X2: GLENWOOD AV Nature: ALARM  CARBON MONOXIDE ALARM Time: 20:43:53  Inc: F11024160
1203 ALFRED AV YE,3FL E  X1: LORI DR X2: ALFRED DR Nature: FIRE-BLD BUILDING FIRE, WITH ENTRAPMENT Time: 01:21:32  Notes: SMOKE INSIDE - FEMALE CALLER CANNOT GET OUT   Inc: F11021062
164 MELROSE AV EL  X1: PEMBROKE AV X2: EMERSON AV Nature: FIRE-OTH WIRES/TRANSFORMER,  W/HAZARDS Time: 17:21:01  Inc: F11023150

Contact: support@active911.com
[ALERT! Upper Darby (*)] 1220 BLYTHE AV UD X1: DESMOND AVXtWOWNSHIP LINE RD Nature: FIRE-OTH FD\nINVESTIGATION Time: 23:42:27 Notes: 2 PTS Inc: Fq20p703 AM\n
[ALERT! Upper Darby (*)] 2314 GARRETT RD UD : @DON PAPA'S BAKERY X1: OWEN AV X2: WINDERMERE AV\nNature: ALARM AUTOMATIC FIRE ALARM Time: 12:20:36 Notes: BASEMENT Inc:\nF12006791 AM\n
[ALERT! Upper Darby (*)] 6430 MARKET ST UD : ASTRA FOODS INC X1: SEPTA X2: S MILLBOURNE AV\nNature: FIRE-OTH FD INVESTIGATION Time: 06:37:29 Inc: F12006748 AM\n

[] 1030017  1020 GREEN LN UD  X1: S OAK AV X2: ASHLAND AV Nature: BLS-EMS  FALL Time: 17:51:33  Notes: 95 Y/O M   INSIDE   Inc: F12015318 \n
[] 1030017  142 BARRINGTON RD UD,A  X1: SANSOM ST X2: WALNUT ST Nature: ALS-EMS  SYNCOPAL EPISODE Time: 18:04:26  Notes: 43 YOM   Inc: F12015319 \n
[] 1030017  601 LANSDOWNE AV UD : @UPPER DARBY HIGH SCHOOL X1: SCHOOL LN X2: LANSTATE RD Nature: ALS-EMS  UNCONCIOUS PERSON Time: 19:10:41  Notes: 16 YOF   NEAR BASEBALL FIELD   Inc: F12015330 \n
[] 1030017  221 SANFORD RD UD  X1: SHIRLEY RD X2: MADEIRA RD Nature: ALS-EMS  RESPIRATORY DIFFICULTY Time: 20:21:43  Notes:  66 Y/O FEM   Inc: F12015338 \n
[] 1030017  6901 MARKET ST UD : @SEPTA 69TH STREET TERMINAL X1: S 69TH ST X2: COPLEY RD Nature: ALS-EMS  INTENTIONAL OVERDOSE Time: 21:13:21  Notes:  ONBOARD # 8377 RT 108    OUTFRONT    POSS UNCONCIOUS   Inc: F12015347 \n
[] 1030017  301 SAINT LAURENCE RD UD  X1: LATHROP RD X2: N CEDAR LN Nature: ALS-EMS  UNCONCIOUS PERSON Time: 22:14:36  Notes: 70 YOM   DIABETIC   Inc: F12015362 \n
[] 1030017  301 SAINT LAURENCE RD UD  X1: LATHROP RD X2: N CEDAR LN Nature: ALS-EMS  UNCONCIOUS PERSON Time: 22:14:36  Notes: 70 YOM   DIABETIC   Inc: F12015362 \n
[] 1030017  108 MARLBOROUGH RD UD  X1: CHESTNUT ST X2: SANSOM ST Nature: ALS-EMS  SYNCOPAL EPISODE Time: 00:20:05  Notes: 60 YR OLD FEMALE   Inc: F12015381 \n
[] 1030017  256 SANFORD RD UD  X1: SHIRLEY RD X2: MADEIRA RD Nature: ALS-EMS  PEDIATRIC EMERGENCY Time: 00:22:49  Notes: 11 YO M   TROUBLE BREATHING   2ND EMERGENCY   Inc: F12015382 \n
[] 1030017  333 NORTH AV UD,51A : @LAUREL MANOR APTS X1: BEECH AV X2: PROVIDENCE RD Nature: ALS-EMS  SUBJECT DOWN Time: 00:38:38  Inc: F12015384 \n
[] 1030017  6901 MARKET ST UD : @SEPTA 69TH STREET TERMINAL X1: S 69TH ST X2: COPLEY RD Nature: ALS-EMS  INTENTIONAL OVERDOSE Time: 00:45:40  Inc: F12015387 \n
[] 1030017  633 BRIARCLIFF RD UD  X1: WALNUT PARK DR X2: RADBOURNE RD Nature: ALS-EMS  HEAD INJURY Time: 04:06:58  Inc: F12015415 \n
[] 1030017  420 EDMONDS AV UD,2 : @MONTROSE APTS X1: BERRY AV X2: ROSEMONT AV Nature: BLS-EMS  ABDOMINAL-STOMACH PAIN Time: 09:25:54  Notes: 60 Y/O M   Inc: F12015438 \n
[] 1030017  5 HARRISON AV CL  X1: N SPRINGFIELD RD X2: WALNUT ST Nature: ALS-EMS  HYPERTENSION Time: 09:29:01  Notes:  83 YOA FEMALE   Inc: F12015439 \n
[] 1030017  2211 WINDSOR AV UD  X1: LANSDOWNE AV X2: ARGYLE RD Nature: ALS-EMS  UNCONCIOUS PERSON Time: 10:21:54  Notes:  85 YOA MALE    SHALLOW BREATHING   Inc: F12015451 \n
[] 1030017  436 HARPER AV UD  X1: HILLCREST RD X2: HUEY AV Nature: ALS-EMS  CARDIAC EMERGENCY  Time: 12:21:10  Notes:  45 YOA FEMALE   Inc: F12015466 \n
[] 1030017  436 HARPER AV UD  X1: HILLCREST RD X2: HUEY AV Nature: ALS-EMS  CARDIAC EMERGENCY  Time: 12:21:50  Notes:  45 YOA FEMALE   Inc: F12015466 \n
[] 1030017  536 N SYCAMORE AV UD  X1: PALMERS MILL RD X2: N BISHOP AV Nature: ACC  WITH INJURY REPORTED Time: 12:57:08  Notes:     VEH INTO A HOUSE   Inc: F12015474 \n
[] 1030017  144 N MADISON AV UD  X1: LENOX RD X2: LATHROP RD Nature: ALS-EMS  SUBJECT CHOKING Time: 13:39:39  Notes: FOOD LODGED IN THE ESOPHAGAS   51 Y/O M   Inc: F12015479 \n
[] 1030017  126 N FAIRVIEW AV UD  X1: LENOX RD X2: PARKVIEW RD Nature: BLS-EMS  BACK PAIN/INJURY Time: 15:23:22  Notes: 37 Y/O FEM   Inc: F12015493 \n
[] 1030017  6848 MARKET ST UD  X1: KENT RD X2: S 69TH ST Nature: BLS-EMS  SICK PERSON Time: 17:26:22  Notes: 44 YR OLD MALE   AT THE PAYPHONE   POSS DETOX PT   Inc: F12015505 \n
[] 1030017  131 HILLDALE RD UD  X1: HEMLOCK RD X2: ROSELAWN AV Nature: FIRE-BLD  BUILDING FIRE, RES/DWELLING Time: 18:47:34  Inc: F12015514 \n
[] 1030017  1009 FOSS AV UD  X1: BOND AV X2: MARVINE AV Nature: ALARM  CARBON MONOXIDE ALARM Time: 19:19:40  Inc: F12015520 \n
[] 1030017  15 GARRETT RD UD,307 : @KILLEGARY COURT APTS X1: MARKET ST X2: GARRETT ALY Nature: ALS-EMS  PEDIATRIC EMERGENCY Time: 20:07:43  Notes: 9 YR OLD FEMALE   HEAD INJURY AFTER A FALL   Inc: F12015525 \n
[] 1030017  536 IRVINGTON RD UD  X1: HUEY AV X2: SCHOOL LN Nature: ALS-EMS  SUBJECT DOWN Time: 21:04:10  Notes: OUTFRONT   ELDERLY MALE    CONSCIOUS AND ALERT   Inc: F12015533 \n
[] 1030017  136 MARGATE RD UD  X1: SHERBROOK BLVD X2: BRADFORD RD Nature: ALS-EMS  HEAD INJURY Time: 21:11:52  Notes: AFTER A DOMESTIC   Inc: F12015534 \n
[] 1030017  136 MARGATE RD UD  X1: SHERBROOK BLVD X2: BRADFORD RD Nature: ALS-EMS  HEAD INJURY Time: 21:11:52  Notes: AFTER A DOMESTIC   Inc: F12015534 \n
[] 1030017  8203 WEST CHESTER PKE UD : @SUNOCO A PLUS MINI MART X1: SAINT LAURENCE RD X2: PARK AV Nature: ALS-EMS  PEDESTRIAN STRUCK  Time: 22:28:16  Inc: F12015549 \n
[] 1030017  500 MAINE AV UD  X1: CALIFORNIA AV X2: CONNECTICUT AV Nature: ALS-EMS  HEMORRHAGE-BLEEDING Time: 01:21:08  Notes: 50 YR OLD   EPISTAXIS   Inc: F12015562 \n
[] 1030017  519 GIA CIR UD,B  X1: PALMERS MILL RD Nature: BLS-EMS  FALL Time: 06:05:50  Notes: 85 YOF   Inc: F12015590 \n
[] 1030017  807 BURMONT RD UD,C  X1: STATE RD X2: CEDAR LN Nature: ALS-EMS  ASSAULT VICTIM Time: 07:38:07  Inc: F12015600 \n
[] 1030017  66 N KEYSTONE AV UD  X1: VICTORY AV X2: WEST CHESTER PKE Nature: ALS-EMS  SYNCOPAL EPISODE Time: 08:28:33  Notes: 3RD PARTY CALL FROM ALARM CO   Inc: F12015607 \n
[] 1030017  327 LANSDOWNE AV UD  X1: MARSHALL RD X2: GREENHILL RD Nature: ALS-EMS  CARDIAC EMERGENCY  Time: 08:36:19  Notes: UNKN AGE   Inc: F12015610 \n
[] 1030017  8 ELM AV UD  X1: WEST CHESTER PKE X2: MILLER AV Nature: ALS-EMS  POSSIBLE DEAD ON ARRIVAL Time: 10:28:24  Notes: PRONOUNCEMENT NEEDED   Inc: F12015625 \n
[] 1030017  4649 WOODLAND AV UD  X1: ANDERSON AV X2: ROBERTS AV Nature: BLS-EMS  ABDOMINAL-STOMACH PAIN Time: 10:41:39  Notes: 91YOF   Inc: F12015628 \n
[] 1030017  6901 MARKET ST UD : @SEPTA 69TH STREET TERMINAL X1: S 69TH ST X2: COPLEY RD Nature: ALS-EMS  DIABETIC EMERGENCY Time: 10:52:44  Notes: COFFEE SHOP   SEPTA PD ON LOCATION   Inc: F12015633 \n
[] 1030017  X1: WEST CHESTER PKE X2: TERMINAL SQ Nature: ALS-EMS  UNCONCIOUS PERSON Time: 11:16:21  Notes: WHI SUV   AT THE INTERSECTION   Inc: F12015636 \n
[] 1030017  460 S 69TH ST UD : @WAWA CONVENIENCE STORE X1: MARSHALL RD X2: PATTERSON AV Nature: ALS-EMS  NATURE UNKNOWN Time: 11:37:43  Notes: ORIENTAL FEMALE IN THE STORE STATING SHE'S SICK   Inc: F12015639 \n
[] 1030017  83 S STATE RD UD : @PARKWOOD MANOR APTS X1: PENARTH AV X2: HAZEL AV Nature: ALS-EMS  SYNCOPAL EPISODE Time: 12:37:48  Notes: OUT FRONT   41 Y/O MALE   Inc: F12015649 \n
[] 1030017  32 GLENDALE RD UD : @CITIZENS BANK X1: LUDLOW ST X2: CHESTNUT ST Nature: ALS-EMS  SUBJECT DOWN Time: 12:38:46  Notes:  IN THE REAR    W/M LAYING IN THE REAR   Inc: F12015650 \n
[] 1030017  X1: LANSDOWNE AV X2: GARRETT RD Nature: ALS-EMS  SUBJECT DOWN Time: 12:44:46  Notes: TROLLEY \ PLATFORM   Inc: F12015651 \n
[] 1030017  5315 W TOWNSHIP LINE RD UD : @TOWNSHIP LINE BEVERAGE Nature: ALS-EMS  HYPERTHERMIA Time: 12:51:21  Inc: F12015653 \n
[] 1030017  7700 WEST CHESTER PKE UD : @WELCOME HOUSE X1: KENMORE RD X2: ENGLEWOOD RD Nature: BLS-EMS  LACERATION Time: 13:06:43  Notes: FINGER... 50 YOF   F/M CUT HERSELF W/ STEAK KNIFE..BLEEDING CONTROLLED   Inc: F12015656 \n
[] 1030017  22 S FAIRVIEW AV UD,2  X1: WEST CHESTER PKE X2: HAZEL AV Nature: ALS-EMS  HEART ATTACK Time: 13:38:25  Notes: 56 YOF   RESP DISTRES   Inc: F12015661 \n
[] 1030017  123 S 69TH ST UD : @RITE AID PHARMACY X1: SANSOM ST X2: WALNUT ST Nature: ALS-EMS  OBSTETRICS EMERGENCY Time: 14:09:51  Inc: F12015668 \n
[] 1030017  1250 PROVIDENCE RD UD,84A : @LAUREL MANOR APTS X1: WYNNBROOK RD X2: SOUTH AV Nature: BLS-EMS  SICK PERSON Time: 14:34:37  Notes: APT 84A    52 YOA MALE    TESTICAL INFECTION   Inc: F12015669 \n

*/

public class PADelawareCountyBParser extends FieldProgramParser {
  
  private static final Pattern CAP_PTN = Pattern.compile("^(\\d{7}) ");
  
  private AddressField addressField;
  
  private boolean crossAddress;
  
  public PADelawareCountyBParser() {
    super(CITY_CODES, "DELAWARE COUNTY", "PA",
           "ADDR/S X1:XADDR? X2:X? Nature:CALL! Time:TIME Notes:INFO? Inc:ID");
  }
  
  @Override
  public boolean parseMsg(String body, Data data) {
    Matcher match = CAP_PTN.matcher(body);
    if (match.find()) {
      data.strUnit = match.group(1);
      body = body.substring(match.end()).trim();
    }
    
    crossAddress = false;
    return super.parseMsg(body.replace('\n', ' '), data);
  }
  
  @Override
  public String getProgram() {
    return "UNIT " + super.getProgram();
  }
  
  private class MyAddressField extends AddressField {
    
    @Override
    public void parse(String field, Data data) {
      Parser p = new Parser(field);
      data.strPlace = p.getLastOptional(':');
      if (data.strPlace.startsWith("@")) data.strPlace = data.strPlace.substring(1).trim();
      data.strApt = p.getLastOptional(',');
      super.parse(p.get(), data);
    }
    
    @Override
    public String getFieldNames() {
      return "ADDR CITY APT PLACE";
    }
  }
  
  private class CrossAddressField extends CrossField {
    @Override
    public void parse(String field, Data data) {
      if (data.strAddress.length() == 0) {
        crossAddress = true;
        addressField.parse(field, data);
      } else {
        super.parse(field, data);
      }
    }
  }
  
  private class MyCrossField extends CrossField {
    @Override
    public void parse(String field, Data data) {
      if (crossAddress) {
        data.strAddress = append(data.strAddress, " & ", field);
      } else {
        super.parse(field, data);
      }
    }
  }
  
  @Override
  public Field getField(String name) {
    if (addressField == null) addressField = new MyAddressField();
    if (name.equals("ADDR")) return addressField;
    if (name.equals("XADDR")) return new CrossAddressField();
    if (name.equals("X")) return new MyCrossField();
    return super.getField(name);
  }
  
  private static final Properties CITY_CODES = buildCodeTable(new String[]{
      "AL", "ALDAN",
      "AS", "ASTON TWP",
      "BE", "BETHEL TWP",
      "BM", "BIRMINGHAM TWP",
      "BR", "BROOKHAVEN",
      "CC", "CHESTER",
      "CF", "CHADDS FORD TWP",
      "CH", "CHESTER HEIGHTS",
      "CL", "CLIFTON HEIGHTS",
      "CN", "CONCORD TWP",
      "CO", "COLLINGDALE",
      "CW", "COLWYN",
      "DB", "DARBY",
      "DT", "DARBY TWP",
      "ED", "EDDYSTONE",
      "EG", "EDGEMONT TWP",
      "EL", "EAST LANSDOWNE",
      "ES", "ESSINGTON", // SECTION OF TINNICUM TWP
      "FL", "FOLCROFT",
      "GL", "GLENOLDEN",
      "HV", "HAVERFORD TWP",
      "LA", "LANSDOWNE",
      "LC", "LOWER CHICHESTER TWP",
      "LS", "LESTER", // SECTION OF TINNICUM TWP
      "MB", "MILLBOURNE",
      "MD", "MIDDLETOWN TWP",
      "ME", "MEDIA",
      "MH", "MARCUS HOOK",
      "MO", "MORTON",
      "MP", "MARPLE TWP",
      "NP", "NETHER PROVIDENCE TWP",
      "NT", "NEWTOWN TWP",
      "NW", "NORWOOD",
      "PK", "PARKSIDE",
      "PP", "PROSPECT PARK",
      "RN", "RADNOR TWP",
      "RP", "RIDLEY PARK",
      "RT", "RIDLEY TWP",
      "RU", "RUTLEDGE",
      "RV", "ROSE VALLEY",
      "SH", "SHARON HILL",
      "SP", "SPRINGFIELD TWP",
      "SW", "SWARTHMORE",
      "TB", "THORNBURY TWP",
      "TC", "CHESTER TWP",
      "TD", "TREDYFFRIN TWP",
      "TN", "TINNICUM TWP",
      "TR", "TRAINER",
      "UC", "UPPER CHICHESTER TWP",
      "UD", "UPPER DARBY TWP",
      "UL", "UPLAND",
      "UP", "UPPER PROVIDENCE TWP",
      "YE", "YEADON",
      
      "NCC", "NEW CASTLE COUNTY"
    
  });
}
